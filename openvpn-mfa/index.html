
<!DOCTYPE html>
<html lang="en-us">

    <head>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <meta property="og:title" content=" Multi-Factor Authentication In OpenVPN &middot;  ninjaduck" />
        <meta property="og:site_name" content="ninjaduck" />
        <meta property="og:url" content="http://www.ninjaducks.in/openvpn-mfa/" />

    
        <meta property="og:type" content="article" />
        <meta property="og:article:published_time" content="2015-07-10T13:35:54&#43;05:30" />
        <meta property="og:article:tag" content="OpenVPN" />
        <meta property="og:article:tag" content="Mozilla" />
        

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@" />
        <meta name="twitter:creator" content="@" />
        <meta name="twitter:title" content="Multi-Factor Authentication In OpenVPN" />
        <meta name="twitter:description" content="" />
        <meta name="twitter:url" content="http://www.ninjaducks.in/openvpn-mfa/" />
    

        <title> Multi-Factor Authentication In OpenVPN &middot;  ninjaduck</title>

    
        <meta name="description" content="" />
    
        
        <meta name="p:domain_verify" content="fc173d84e3a4de948ed4bda2908afd3e"/>
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        
          

    
        <link href="http://www.ninjaducks.in/index.xml" rel="alternate" type="application/rss+xml" title="ninjaduck" />
    

    
        <link rel="canonical" href="http://www.ninjaducks.in/openvpn-mfa/" />

    
    <script type="application/ld+json">
    { 
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Multi-Factor Authentication In OpenVPN",
        "author": {
            "@type": "Person",
            "name": "http://profiles.google.com/?rel=author"
        },
        "datePublished": "2015-07-10",
        "description": "",
        "wordCount":  738 
    }
    </script>
    
    <link href='http://fonts.googleapis.com/css?family=Vollkorn' rel='stylesheet' type='text/css'>
    <style>
*{padding:0;margin:0}body,html{font-size:1em;line-height:1.65em;font-family:"Open Sans",sans-serif;font-weight:300;color:#444}html{height:100%}body{padding:2em 2.5em 1em 20em}header{background-color:#5CC265;border-right:1px #eee solid;padding:2em;position:fixed;top:0;left:0;height:100%;width:13.5em}#content{display:block;width:100%}footer{padding:1em 0 2.5em;font-size:.8em;line-height:1.5em;color:#888}article{border-bottom:.1em #eee solid;padding-bottom:1.7em;max-width:56em}h4,h5,h6,hr,p{margin-top:.9em;margin-bottom:.9em}h1,h2,h3,h4,h5,h6{font-family:"Bree Serif",serif;font-weight:400!important}h1{font-size:2.5em;line-height:1.1em;margin-top:.6em;margin-bottom:.6em}h2{font-size:1.9em;line-height:1.2em;margin-top:.7em;margin-bottom:.7em}h3{font-size:1.4em;line-height:1.3em;margin-top:.8em;margin-bottom:.8em}h4{font-size:1.3em}h5{font-size:1.2em}h6{font-size:1.1em}iframe,img{max-width:100%}a{color:#79B97F;text-decoration:none;}a:hover{text-decoration:underline}h1 a,h2 a,h3 a,h4 a,h5 a,h6 a{font-weight:400!important; color:#444;}strong{font-weight:700}blockquote{border-left:.4em solid #eee;padding-left:1.2em;font-size:1.3em}hr{border:0;height:1px;background:#eee}ol,ul{margin-left:3em}code{font-size:1.4em;background:#eee}pre{font-size:.8em;line-height:2em;background:#eee;padding:1em;word-break:break-all;word-wrap:break-word;white-space:pre;white-space:-moz-pre-wrap;white-space:pre-wrap}input{font-size:1em;padding:.3em}header h1{font-size:1.9em;margin-top:.8em;margin-bottom:0 !important}header h1 a{color:white}header h1 a:hover{text-decoration:none}header #follow-icons{font-size:.7em;margin-top:0.7em;margin-bottom:1.5em}#follow-icons a{color:#ccc}#follow-icons span{vertical-align:top;margin-left:-.15em;margin-right:-.15em}#follow-icons span .fa-stack-1x{font-size:1.05em;line-height:1.9em}header h6{margin-top:.5em}article span.post-stamp{color:#888}h1.post-title{margin-top:-0.35em;margin-bottom:.6em}h3.post-title{margin-top:.4em;padding-bottom:.9em;border-bottom:1px solid #eee;font-size:1.2em;color:#CCC}.post-title .feature-star{font-size:.9em}.feature-star,.separator,.taglist{color:#ccc}.taglist a{color:#79B97F;display:inline-block;line-height:1.5em;padding:.3em .6em;vertical-align:20%;font-size:.5em;font-family:"Open Sans",sans-serif;font-weight:700!important;text-transform:uppercase;letter-spacing:.05em;text-decoration:underline;}.categorylist a{background-color:rgb(135, 186, 140);color:white;display:inline-block;line-height:1.5em;padding:.3em .6em;vertical-align:20%;font-size:.8em;font-family:"Open Sans",sans-serif;font-weight:700!important;text-transform:uppercase;letter-spacing:.05em;border-radius:0.25em;-moz-border-radius: 0.25em;-webkit-border-radius: 0.25em;}.line-separator{height:3.5em;width:90%;margin-bottom:-1em;margin-top:-0.4em;}#social-bar{margin-top:1.5em;background-color:#eee;padding:.5em}#comments{margin-top:.15em;padding-bottom:.2em;border-bottom:1px solid #eee}.pagination{margin-bottom:1em}footer a{font-weight:300;color:#888;text-decoration:underline}footer a:hover{color:#444;text-decoration:none}@media only screen and (min-width:1281px){body,html{font-size:1.1em}}@media only screen and (max-width:800px){body{padding:0}header{border-right:none;border-bottom:1px #eee solid;position:relative;height:auto;width:auto;text-align:center;padding-bottom:1em}#content{margin-left:0;padding:2em 2em 1em;width:auto}footer{padding:0 2.5em 2em}}@media only screen and (max-width:320px){#content,header{padding:1.2em 1.2em .6em}footer{padding:0 1.5em 1.2em}ol,ul{margin-left:2em}}
</style>
    </head>
    <body>
        <header id="header">
            <a id="logo" href="http://www.ninjaducks.in/"><img src="http://www.ninjaducks.in/images/duck.png" alt="ninjaduck" /></a>
            <h1><a href="http://www.ninjaducks.in/" style="font-family: 'Vollkorn', serif;font-size:1.3em;">ninjaduck</a></h1>
            

            <div id="follow-icons">
	<a href="http://facebook.com/shivanshuag" rel="me"><i class="fa fa-facebook-square fa-2x"></i></a>
	<a href="http://twitter.com/shivanshuagw" rel="me"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://www.linkedin.com/pub/shivanshu-agrawal/65/309/74" rel="me"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://github.com/shivanshuag" rel="me"><i class="fa fa-github-square fa-2x"></i></a>
	<a href="http://plus.google.com/+ShivanshuAgrawal" rel="author"><i class="fa fa-google-plus-square fa-2x"></i></a>
	<a href="http://www.ninjaducks.in/index.xml" rel="me"><i class="fa fa-rss-square fa-2x"></i></a> 
</div>  
            <h6><a href="http://www.ninjaducks.in/">All Posts</a></h6>
<h6><a href="http://www.ninjaducks.in/thesis/main.html">M.Tech Thesis</a></h6>
<h6><a href="http://www.ninjaducks.in/about">About</a></h6>

        </header>
<main id="content">

<article id="" class="top">
    <h1 class="post-title">Multi-Factor Authentication In OpenVPN</h1>
    <figure class="pull-right">
    <img src="http://www.ninjaducks.in/images/MWoS.png"/> 
</figure>

<p>This project was done as a part of <a href="https://blog.mozilla.org/security/2014/05/15/introducing-mozilla-winter-of-security-2014/">Mozilla Winter of Security 2014</a> programme.
The objective of this project is to implement native Multifactor Authentication Support for OpenVPN. The existing support for Multifactor Authentication in OpenVPN is through deferred C plugins and pythons scripts which has lots of limitations due to the nature they are implemented.</p>
<h2 id="need-to-native-mfa-support">Need to Native MFA support</h2>
<p>The plugins are present on the server side where they are called at appropriate places in the authentication process of OpenVPN with credentials. But on the client side, openVPN provides the users options for authenticating through static keys, username/Password or certificates. There is no support for entering OTP or any other credential here. This user ahs to resort to using hacky ways to circumvent this limitation like entering the OTP cancatenated with password which can lead to even more limitations on the length of password and so on. An example plugin, used by mozilla, can be found at <a href="https://github.com/mozilla-it/duo_openvpn">https://github.com/mozilla-it/duo_openvpn</a> .</p>
<p>This method can also limits the type of credentials that can be taken from the user. Typical Multifactor Authentication solutions also provide Push notifications on smartphones as a way for authentication along with the regular OTP method. Native Support for Multifactor Authentication in OpenVPN will help in supporting these modes of authentication.</p>
<p>Another use of native MFA support can be maintaining user sessions so that the user does not have to enter the second factor of authentication every time he/she logs in but say only once in a month. These reasons demand for native MFA suport in OpenVPN.</p>
<h2 id="mfa-implementation">MFA Implementation</h2>
<p>Our scheme of implementation provides support for three different types of authentication: OTP, Push and User-pass (as of yet) in addition to the certificate check that happens as a part of the normal TLS handshake.</p>
<p>We have modified the <a href="https://openvpn.net/index.php/open-source/documentation/security-overview.html">key-method 2</a> packet structure used for authentication to include MFA credentials. MFA username and password are sent to the script/plugin in a manner similar to the existing auth-user-pass soution . In case of OTP when there is no username, CN of the user is sent as username. In case of PUSH, CN is sent as username and an empty string as password. Three types of plugins are supported for MFA, one for each of push, otp and user-pass.</p>
<p>The type for push is - <code>OPENVPN_PLUGIN_AUTH_MFA_PUSH_VERIFY</code></p>
<p>for otp - <code>OPENVPN_PLUGIN_AUTH_MFA_OTP_VERIFY</code></p>
<p>for user-pass - <code>OPENVPN_PLUGIN_AUTH_MFA_USER_PASS_VERIFY</code></p>
<h2 id="mfa-usage-and-config">MFA Usage and Config</h2>
<p>In the server config, put the supported authentication methods as follows</p>
<p><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mfa-method method-type <span style="color:#333">[</span>script_file via-env|via-file<span style="color:#333">]</span></code></pre></div>
Here method type can be &lsquo;otp&rsquo;, &lsquo;push&rsquo;, &lsquo;user-pass&rsquo;. For example</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mfa-method otp auth.pl via-file</code></pre></div>
<p>The three methods differ in what credentials are asked from the user for authentication. In otp, only password is asked. In push, nothing is asked. This is meant for authentication by Push notification on mobile phones which can be handled by a deferred auth plugin on the server side. In user-pass, both username and password are asked from the user. If you want to use a plugin for authentication on the server, include the following lines in the config</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mfa-method method-type
plugin plugin_shared_object_file</code></pre></div>
<p>In the client config, put the following line</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mfa-method mfa-type</code></pre></div>
<p>User can authenticate using one method only. Multiple mfa-method lines will give an error.</p>
<h2 id="session-support-implementation">Session Support Implementation</h2>
<p>On startup the OpenVPN server generates a random key (48 bytes). When a client successfully authenticates with MFA enabled, the server generates a session token using the tls1_PRF function with the key as the secret and (Client CN + Expiry timestamp) as the data. The expiry timestamp and the token are sent to the client. When the client wants to connect later, it must send the token and the expiry timestamp. If verification succeeds, MFA auth is bypassed. If not, auth fails and the client is prompted for MFA authentication if the auth-retry directive is set to &ldquo;interact&rdquo;.</p>
<h2 id="session-support-usage-and-config">Session Support Usage and Config</h2>
<p>The server needs to provide the following configuration option:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mfa-session-expiration session-validity</code></pre></div>
<p><code>session-validity</code> is the duration (in hours) for which the session cookie is valid.</p>
<p>The client needs to provide the following configuration option:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mfa-session-file filename</code></pre></div>
<p><code>filename</code> is the path to the file in which session tokens will be stored. If the filename is not provided, then we warn the user and disable session-support.</p>
<h2 id="code-demo-and-presentations">Code, Demo and Presentations</h2>
<p>The code for this project can be found at <a href="https://github.com/mozilla/openvpn">https://github.com/mozilla/openvpn</a>. The project wiki can be found <a href="https://wiki.mozilla.org/Security/Mentorships/MWoS/2014/OpenVPN_MFA">here</a>.</p>
<p>A video where we have explained the project and given a demo is present <a href="https://air.mozilla.org/mwos-2014-openvpn-mfa/">here</a>.</p>

    <div id="comments">
    
    
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'shivanshuag';
      var disqus_identifier = 'http:\/\/www.ninjaducks.in\/openvpn-mfa\/';
      var disqus_title = 'Multi-Factor Authentication In OpenVPN';
      var disqus_url = 'http:\/\/www.ninjaducks.in\/openvpn-mfa\/';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    
</div>

</article>  

</main>
		<footer id="footer">
			<section id="footer-message">&copy; ninjaduck. All rights reserved. Powered by <a href="http://gohugo.io" target="_blank">Hugo</a>.</section>
		</footer>

    <script>
      (function(c,f){asyncLoader=function(i,h){i.foreach(function(k,j){e(j,d(j),h)});if(typeof h.callback=="function"){var g=setInterval(function(){if(f.readyState==="complete"){clearInterval(g);h.callback()}},10)}};var d=function(g){var h=g.split(".");return h[h.length-1]},e=function(h,i,g){switch(i){case"js":a(h,g);break;case"css":b(h);break;default:break}},a=function(i,h){var g=document.createElement("script");g.type="text/javascript";g.async=true;g.src=i;document.getElementsByTagName("head")[0].appendChild(g)},b=function(g){var h=document.createElement("link");h.type="text/css";h.rel="stylesheet";h.href=g;document.getElementsByTagName("head")[0].appendChild(h)};Array.prototype.foreach=function(h){for(var g=0;g<this.length;g++){h(g,this[g])}}})(this,document);

      var WebFontConfig={google:{families:["Open Sans:300italic,700italic,300,700","Bree+Serif"]}};
      asyncLoader([
        "//netdna.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.css",
        "//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js",
        "//cdnjs.cloudflare.com/ajax/libs/webfont/1.5.16/webfontloader.js",
        "//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"
      ],{
        callback:function(){
          asyncLoader([
            "http:\/\/www.ninjaducks.in\/css/rrssb.css",
            "http:\/\/www.ninjaducks.in\/js/gist.min.js", 
            "http:\/\/www.ninjaducks.in\/js/rrssb.min.js",
            "//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css"
          ], { callback:function() {
              hljs.initHighlighting();
          }});
        }
      });
    </script>
	
    <script>
    	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      	ga('create', 'UA-47255777-1', 'auto');
      	ga('send', 'pageview');
    </script>
  
	</body>
</html>